services:
  postgres:
    image: postgres:16-alpine
    container_name: cinebh-db
    environment:
      POSTGRES_DB: ${DB_NAME:-cinebh}
      POSTGRES_USER: ${DB_USERNAME:-postgres}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-postgres}
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USERNAME:-postgres} -d ${DB_NAME:-cinebh}"]
      interval: 10s
      timeout: 5s
      retries: 5

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: cinebh-backend
    environment:
      DB_URL: jdbc:postgresql://postgres:5432/${DB_NAME:-cinebh}
      DB_USERNAME: ${DB_USERNAME:-postgres}
      DB_PASSWORD: ${DB_PASSWORD:-postgres}
      FRONTEND_URL: https://localhost:3000
      SERVER_PORT: 8443
      SERVER_SSL_KEY_STORE_PASSWORD: changeit
      MAIL_USERNAME: ${MAIL_USERNAME:-}
      MAIL_PASSWORD: ${MAIL_PASSWORD:-}
      MAIL_FROM: ${MAIL_FROM:-noreply@cinebh.com}
      JWT_SECRET: ${JWT_SECRET:-yourjwtsecretkeychangeinproduction123456789}
    ports:
      - "8443:8443"
    volumes:
      - ./backend/.cert:/app/.cert:ro
    depends_on:
      postgres:
        condition: service_healthy

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: cinebh-frontend
    environment:
      REACT_APP_API_URL: https://localhost:8443/api
      REACT_APP_WS_URL: https://localhost:8443/ws-cinema
      HTTPS: "true"
      HOST: 0.0.0.0
      SSL_CRT_FILE: /app/.cert/cert.pem
      SSL_KEY_FILE: /app/.cert/key.pem
    ports:
      - "3000:3000"
    volumes:
      - ./frontend/.cert:/app/.cert:ro
    depends_on:
      - backend

  db-init:
    image: postgres:16-alpine
    container_name: cinebh-db-init
    volumes:
      - ./backend/src/main/resources/db/seed/seed_data.sql:/seed_data.sql
    environment:
      PGPASSWORD: ${DB_PASSWORD:-postgres}
    depends_on:
      backend:
        condition: service_started
    command: >
      sh -c "
        echo 'Waiting for backend to complete migrations...' &&
        sleep 15 &&
        echo 'Loading seed data...' &&
        psql -h postgres -U ${DB_USERNAME:-postgres} -d ${DB_NAME:-cinebh} -f /seed_data.sql &&
        echo 'Seed data loaded successfully!'
      "
    restart: on-failure

volumes:
  postgres_data:
